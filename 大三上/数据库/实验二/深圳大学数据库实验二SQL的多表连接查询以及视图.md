

| 实验目的： 掌握postgresql的服务管理、命令行服务管理，熟悉集群服务配置管理方式； 熟悉并掌握数据库查询与数据库视图的基础原理； 掌握利用SQL语句进行多表连接查询、建立并操纵视图的方法。 实验要求： 1、练习postgresql服务管理配置； 2、练习典型的多表连接查询SQL语句、聚合函数； 3、练习视图的创建查询、插入、更新、删除等操作                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 实验环境： 软件：liunx系统，centos   **（根据自己实验环境填写）**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 实验内容 在服务器端练习postgresql的系统配置、用户环境配置、集群服务配置：  1. 实现服务的自启动，将“源码包/contrib/start-scripts”目录下的脚本重命名为linux1后放到/etc/init.d目录下，并使用sudo chkconfig --add linux1指令添加服务自启动（图1-1-1）。对操作系统进行配置如图1-1-2所示，对Linux资源限制调整如图1-1-3所示，对系统防火墙配置如图1-1-4所示。 ![](media/65166407cb37dbe0fd18e8a7d25860d4.png) 图1-1-1 ![](media/b31e0aa86ea62cf422095edfc59c0c70.png) 图1-1-2 ![](media/4d874c7ad8764d51c80d415157183002.png) 图1-1-3 ![](media/149265b59cf3a04151cf6ba590cfe7a8.png) 图1-1-4 2. 配置环境变量（图1-1-5），测试pg_ctl（图1-1-6），成功。 ![](media/7ce489259ed613f1798b384dc0258b67.png) 图1-1-5![](media/54bfcf47e50a63947759ec373bb8e852.png) 图1-1-6   3.pg_hba.conf配置（图1-1-7），postgresresql.conf配置与重新启动pg_ctl（图1-1-8），进入postgres后输入show all （图1-1-9）以及select语句（图1-1-10）查看当前所有配置。 ![](media/11a55c451c3f1b073d26256b2234a8d2.png) 图1-1-7 ![](media/4377fa448426e71ab19b44cb67d63117.png) ![](media/24f4486b777e54eea4fa5fa9e77000e1.png) ![](media/84e3a00b04447c0ac591842694a105f2.png) ![](media/9b7b3c4ed857a10ab3aa947441940eb2.png) ![](media/e6c7505ff22378082bd444682a39efb6.png) ![](media/0980a8491133f1c53b1322768474f4d3.png) ![](media/9ad834dc7d1b6c0b6c07c3e90c243d12.png) ![](media/3a923577722549cad087325f4b6b4ff2.png) ![](media/a2f7c46304962b3fc975f3e3ff8034f9.png) 图1-1-8 ![](media/87ec275050014eb06c7097e38c671ed3.png) 图1-1-9 ![](media/8443af02053069906d064543740b22dd.png) 图1-1-10 在实验一的基础上完成EX2-EX7的SQL练习题  **Ex2** 1.Find the name and salary of employees in Luton.  语句：  select emp2017303010.ENAME,emp2017303010.SAL from emp2017303010 inner join dep2017303010 on emp2017303010.DEPTNO = dep2017303010.DEPTNO where dep2017303010.loc='LUTON';  结果（图2-2-1）：  ![](media/4a1a3f30ae3024fd274566d60afb90e0.png) 图2-2-1 4.List all departments that do not have any employees. \* use join and no subquery  语句：  select dep2017303010.deptno,dep2017303010.dname,dep2017303010.loc from emp2017303010 right join dep2017303010 on emp2017303010.DEPTNO =dep2017303010.DEPTNO where empno is null;  结果（图2-2-4）： ![](media/742ea15632629cc0679b752a1bb68547.png) 图2-2-4 5.For each employee whose salary exceeds his manager's salary, list the employee's name and salary and the manager's name and salary.   语句:  select e.ename,e.sal,m.ename,m.sal from emp2017303010 e,emp2017303010 m where e.mgr=m.empno and e.sal\>m.sal;  结果（图2-2-5）： ![](media/ddcef2c16794377ee5bed8caf69a9616.png) 6.List the employees who have BLAKE as their manager.  语句：  select \* from emp2017303010 e where e.mgr=(select empno from emp2017303010 where ename= 'BLAKE');  结果（图2-2-6）： ![](media/4348891bc2d9f599cb93ed66e75c963f.png) 图2-2-6 **Ex3** 2.Compute the average annual income (income is salary plus commission) for all salesmen  语句：  select AVG(e.sal+e.comm) from emp2017303010 e where job='SALESMAN';  结果（图2-3-2）： ![](media/46b4ee4a5595b874e7f4f4796afd90bd.png) 图2-3-2 3.Find the number of characters in the longest department name  语句：  select max(length(dname)) from dep2017303010;  结果（图2-3-3）： ![](media/c248de0372889022a89b7b79283b740a.png) 图2-3-3 5.Count the number of people in department 30 who receive a salary and the number of people who receive a commission (single statement).  语句：  Select \* from (select count(\*) as both_comm_man from (select e.empno from emp2017303010 e where e.deptno = 30 and e.comm is not null)temp1) tempa, (select count(\*) as salary_man from (select e.empno from emp2017303010 e where e.sal is not null and e.deptno = 30)temp2)tempb;   结果（图2-3-5）： ![](media/0b52c50aded72d02d5d65ddb54fba75e.png) 图2-3-5 8.Compute the daily and hourly salary for employees in department 30, round to the nearest penny. Assume there are 22 working days in a month and 8 working hours in a day.(Use function round())  语句：  select \*,round((sal)/22) as Daily_salary,round(((sal)/(22\*8))) as Hour_salary from emp2017303010 e where deptno=30;  结果（图2-3-8） ![](media/7fcf57d2d1affc620f719f234ba3dad7.png) 图2-3-8 **Ex4** 1.Select the name, job, and date of hire of the employees in department (Format the HIREDATE column to MM/DD/YY)   语句：  select ename,job,to_char(hiredate,'MM/DD/YY') from emp2017303010;  结果（图2-4-1）： ![](media/cb86f296ca8b7692ad03a4afc27bf572.png) 图2-4-1 2.Then format the HIREDATE column into DoW (day of the week), Day (day of the month), MONTH (name of the month) and YYYY(year)  语句：  Select ename,job,to_char(hiredate,'DoW,Day,MONTH,YYYY') from emp2017303010;  结果（图2-4-2）： ![](media/a7589353a161f0d3c285dd6cc4af9947.png) 图2-4-2 3.Which employees were hired in April?  语句：  select \*,to_char(hiredate,'MONTH') as hire_month from emp2017303010 where to_char(hiredate,'MONTH') like 'APRIL%';  结果（图2-4-3）： ![](media/de6a56269097ca30b1617bbab3a6a00b.png) 图2-4-3 5.Are there any employees who have worked more than 30 years for the company?  语句：  select \* from emp2017303010 where date_part('year',now())-date_part('year',hiredate)\>30;  结果（图2-4-5）： ![](media/bbaa3854be466192914e2724a77ae823.png) 图2-4-5 6.Show the weekday of the first day of the month in which each employee was hired. (plus their names)  语句：  select ename,hiredate,extract(DOW FROM cast ( to_date ( to_char ( date_trunc ( 'month' , hiredate ) , 'YYYY/MM/DD' ) , 'YYYY/MM/DD' ) as TIMESTAMP)) as First_weekday from emp2017303010;  结果（图2-4-6）： ![](media/631bba964b441c740fdeb3d28b84b5ef.png) 图2-4-6 7.Show details of employee hiredates and the date of their first payday.  (Paydays occur on the last Friday of each month) (plus their names) \*此题为附加题  语句：  1、find_firstsalday函数 Create or replace function find_firstsalday(d1 date) returns  Date as \$\$  DECLARE  D2 date;  D3 timestamp;  Begin  D3= date_trunc('month',d1 + interval '1 MONTH - 1 DAY'); D2 = to_date(to_char(D3,'YYYY/MM/DD'),'YYYY/MM/DD');  while extract(DOW FROM cast(D2 as TIMESTAMP)) \<\> 5 loop  D2 = D2 - 1 'day';   end loop;  return D2 ;  end ;  \$\$ LANGUAGE plpgsql;  2、select语句  select e.empno,e.ename,e.job,e.mgr,e.hiredate,e.sal,e.comm,e.deptno,d.dname,d.loc,find_firstsalday(hiredate) as First_salday from emp2017303010 e inner join dep2017303010 d on e.deptno = d.deptno;  结果（图2-4-8、图2-4-9）： ![](media/e20ffcb22938988ebc9534edcbadb654.png) 图2-4-8 ![](media/2d7d3f74714ddcccf1989f2c45006765.png) 图2-4-9  **Ex5** 2. Divide all employees into groups by department and by job within department. Count the employees in each group and compute each group's average annual salary.  语句：  select d.dname,e.job,count(ename),round(AVG(sal),2) from emp2017303010 e inner join dep2017303010 d on e.deptno = d.deptno group by d.dname,e.job;  结果（图2-5-2）： ![](media/d484c5d260f09ee6478651fc7b029b1b.png) 图2-5-2 5.Find all departments with an average commission greater than 25% of average salary.  语句：  select d.deptno,d.dname,round(AVG(e.comm),2) as comm_avg,round(AVG(e.sal),2) as sal_avg from emp2017303010 e inner join dep2017303010 d on e.deptno = d.deptno group by d.deptno,d.dname having AVG(e.comm)\>AVG(e.sal)\*0.25;  结果（图2-5-5）： ![](media/6877d6f6cb40a70637907b408ae172d6.png) 图2-5-5 6.Find each department's average annual salary for all its employees except the managers and the president.  语句：  select e.deptno,round(AVG(e.sal),2),count(\*) as sal_avg from emp2017303010 e where job \<\> 'MANAGER' and job \<\> 'PRESIDENT' group by e.deptno;  结果（图2-5-6）： ![](media/3c7ebbd60c02f4225c3408603c0431ea.png) 图2-5-6 **Ex6** 1.List the name and job of employees who have the same job as Jones.  语句：  select ename,job from emp2017303010 where job = (select job from emp2017303010 where ename = 'JONES') and ename \<\> 'JONES';  结果（图2-6-1）： ![](media/8e92c6bd5ce145fe9f927996963e7cc6.png) 图2-6-1 3.List the name, job, and department of employees who have the same job as Jones or a salary greater than or equal to Ford.  语句：  select e.ename,d.dname,e.job,e.sal from emp2017303010 e inner join dep2017303010 d on e.deptno = d.deptno where e.job = (select job from emp2017303010 where ename = 'JONES') or e.sal \>= (select sal from emp2017303010 where ename = 'FORD') and e.ename \<\> 'FORD' and e.ename \<\> 'JONES';  结果（图2-6-3）： ![](media/d75914d66b8eb3f0918255dec6a6033d.png) 图2-6-3 4.Find all employees in department 10 that have a job that is the same as anyone in the Sales department  语句： select \* from emp2017303010 where deptno=10 and job = (select job from dep2017303010 where dname = 'SALES');;  结果（图2-6-4）： ![](media/dead7a9c7e1c62a2b545c19077d72118.png) 图2-6-4 7.Find all the employees that earn more than JONES, using temporary labels to abbreviate table names.  语句：  select \* from emp2017303010 e where e.sal\>(select e.sal from emp2017303010 e where e.ename = 'JONES');  结果（图2-6-7）： ![](media/a7dcf1e8a88c73c084469acac252f242.png) 图2-6-7 **Ex7** 1.Create a new table called loans with columns named LNO NUMERIC (3), EMPNO NUMERIC (4), TYPE CHAR(1), AMNT NUMERIC (8,2) \*Don’t forget to create constraints  语句：  create table loans (LNO NUMERIC(3),EMPNO NUMERIC(4),TYPE CHAR(1),AMNT NUMERIC(8,2));  alter table loans add primary key (lno);  结果（图2-7-1）： ![](media/3140870e5c3785b1617853e63b59c2ba.png) 图2-7-1 2.Insert the following data  LNO EMPNO TYPE AMNT  23 7499 M 20000.00  42 7499 C 2000.00  65 7844 M 3564.00  语句：  INSERT INTO loans (lno,empno,type,amnt) VALUES (23, 7499, 'M', 20000.00),(42, 7499, 'C', 2000.00),(65, 7844, 'M', 3564.00);  结果（图2-7-2）： ![](media/9ac9030988f5018fa597c75032291b7b.png) 图2-7-3 4.The Loans table must be altered to include another column OUTST NUMERIC(8,2)  语句：  alter table loans add outst NUMERIC (8,2);  结果（图2-7-4）： ![](media/f3f99f370f563fb351e88fea55a132e3.png) 图2-7-4 5.Add 10% interest to all M type loans  语句：  update loans set amnt = amnt\*1.1 where type = 'M';  结果（图2-7-5）： ![](media/09b0e81d163a23ba5889c7a1aeba1623.png) 图2-7-5 6.Remove all loans less than £3000.00 语句：  delete from loans where amnt \< 3000;  结果（图2-7-6）： ![](media/e0137db857a3b190bff08b10c1696a91.png) 图2-7-6 7.Change the name of loans table to accounts 语句：  alter table loans rename to accounts;  结果（图2-7-7）： ![](media/08ca6e5278fd2cffd503c4e2a535d3a8.png) 图2-7-7  8.Change the name of column LNO to LOANNO 语句：  alter table accounts rename LNO to LOANNO;  结果（图2-7-8）： ![](media/93b76bae7b1a18ad1b55bef7fab762b3.png) 图2-7-8 9.Create a view for use by personnel in department 30 showing employee name, number, job and hiredate 语句：  create view view2017303010 as select ename,empno,job,hiredate from emp2017303010 where deptno=30;  结果（图2-7-9）： ![](media/4e4eeb4b324ef866023f1a0ec994164f.png) 图2-7-9   10.Use the view to show employees in department 30 having jobs which are not salesman 语句：  select \* from view2017303010 where job \<\> 'SALESMAN';  结果（图2-7-10）： ![](media/e11e0f0fb12529c047efefed63124dff.png) 图2-7-10   |
| 实验结论或体会： 实验结论：   实验收获： 1、在bash界面启动pg_ctl时，仍然报错（图5-1），根据网上查阅的[资料](https://www.cnblogs.com/hello-wei/p/10150883.html)未解决问题，猜测可能是自己的路径没写对（图5-2、图5-3、图5-4），修改后如图5-5所示，但是仍然报错，后来向老师提问才明白，我是用的yum安装postgres而不是用的源码安装，因此并不存在pg_ctl，因为yum安装已经自带了，所以启动不了，用户权限不够。 ![](media/7bee0133c142a14af4f6faca906fdad6.png) 图5-1 ![](media/c83f2e3d5642ed410e4cf7722f39a119.png) 图5-2 ![](media/2d8cf503ddfd29c76ed0a128747419d1.png) 图5-3 ![](media/ab874cfa63979ca27c6954880172a41c.png) 图5-4 ![](media/53d434ca862d880a6d90c578eb1d47ca.png) 图5-5  **（给出实验结论，介绍实验过程中遇到的困难，总结实验收获！）**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

深圳大学学生实验报告用纸

| 指导教师批阅意见：           成绩评定：        指导教师签字：  年 月 日 |
|-------------------------------------------------------------------------|
| 备注：                                                                  |

注：1、报告内的项目或内容设置，可根据实际情况加以调整和补充。

2、教师批改学生实验报告时间应在学生提交实验报告时间后10日内。
